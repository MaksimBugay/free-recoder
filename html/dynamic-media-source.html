<!DOCTYPE html>
<html>
<head>
    <title>Dynamic fMP4 Playback</title>
</head>
<body>
<video id="video" controls width="640" height="360"></video>
<input type="file" id="fileInput">
<input type="file" id="fileInput1">
<input type="file" id="fileInput2">
<button id="playButton">Play</button>
<script>
    const mimeType = 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"';

    function delay(milliseconds) {
        return new Promise(resolve => setTimeout(resolve, milliseconds));
    }

    if ('MediaSource' in window && MediaSource.isTypeSupported(mimeType)) {
        const segmentDuration = 5;
        let segmentCounter = 0;
        let finishedSegmentCounter = 0;
        const video = document.getElementById('video');
        const mediaSource = new MediaSource();
        let sourceBuffer;
        let queue = [];
        let savedTime = 0;

        function appendNextChunk() {
            if (queue.length > 0 && !sourceBuffer.updating) {
                try {
                    const chunk = queue.shift();
                    console.log('Appending chunk of size:', chunk.byteLength);
                    sourceBuffer.appendBuffer(chunk);
                } catch (err) {
                    console.error('Error appending buffer:', err);
                }
            } else if (queue.length === 0 && video.paused && mediaSource.readyState === 'open') {
                video.play();
            }
        }

        function fetchAndQueueChunk(chunk) {
            queue.push(chunk);
            appendNextChunk();
        }

        document.getElementById('playButton').addEventListener('click', () => {
            video.src = URL.createObjectURL(mediaSource);
        });

        mediaSource.addEventListener('sourceopen', function () {
                sourceBuffer = mediaSource.addSourceBuffer(mimeType);
                sourceBuffer.mode = 'sequence';

                sourceBuffer.addEventListener('updateend', function () {
                    segmentCounter += 1;
                    appendNextChunk();
                    if (video.paused) {
                        video.play();
                    }
                });

                sourceBuffer.addEventListener('error', function (e) {
                    console.error('SourceBuffer error:', e);
                });

                function processSelectedFile(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();

                        reader.onload = function (e) {
                            const arrayBuffer = e.target.result;
                            fetchAndQueueChunk(arrayBuffer);
                        };

                        reader.onerror = function (e) {
                            console.error("Error reading file:", e);
                        };

                        reader.readAsArrayBuffer(file);
                    } else {
                        console.error("No file selected");
                    }
                }

                document.getElementById('fileInput').addEventListener('change', processSelectedFile);
                document.getElementById('fileInput1').addEventListener('change', processSelectedFile);
                document.getElementById('fileInput2').addEventListener('change', processSelectedFile);
            }
        );
        video.addEventListener('timeupdate', () => {
            savedTime = video.currentTime;
            if (segmentCounter > finishedSegmentCounter) {
                const d = segmentDuration * (finishedSegmentCounter + 1);
                const delta = 0.2
                if ((savedTime > (d - delta)) && (savedTime < d)) {
                    console.log(`${finishedSegmentCounter + 1} segment playing was done`);
                    finishedSegmentCounter += 1;
                    sourceBuffer.timestampOffset = delta;
                    video.currentTime = d;
                    savedTime = video.currentTime;
                }
            }
        });
    } else {
        console.error('MSE or fMP4 format is not supported in your browser.');
    }
</script>
</body>
</html>
